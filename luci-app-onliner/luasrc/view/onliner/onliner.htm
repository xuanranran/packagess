<%#
 Copyright 2008 Steven Barth <steven@midlink.org>
 Copyright 2008-2011 Jo-Philipp Wich <jow@openwrt.org>
 Copyright 2025 Lovin Yarn <juanshengyuan@gmail.com>
 Licensed to the public under the Apache License 2.0.
-%>

<%
local util = require "luci.util"
local function online_data()
	local rv = { }
	-- Simplified awk script focusing only on IPv4 data for maximum compatibility.
	local script = [[
		BEGIN {
			# Read DHCPv4 leases to get hostnames (MAC is $2, hostname is $4)
			while ((getline < "/tmp/dhcp.leases") > 0) {
				host[$2] = $4;
			}

			# Read ARP table for active IPv4 clients (Flags is $3, MAC is $4, IP is $1, Device is $6)
			while ((getline < "/proc/net/arp") > 0) {
				# ADDED FILTER: Only process lines where device is 'br-lan' or starts with 'eth'
				if ($3 == "0x2" && $4 != "00:00:00:00:00:00" && ($6 == "br-lan" || $6 ~ /^eth/)) {
					mac = $4;
					macs[mac] = 1;
					iface[mac] = $6;
					ipv4[mac] = $1;
				}
			}

			# Print combined results for every MAC found in the active ARP table
			for (mac in macs) {
				hostname = host[mac] ? host[mac] : "?";
				print hostname, ipv4[mac], mac, iface[mac];
			}
		}
	]]
	local fd = util.execi('/usr/bin/awk \'' .. script:gsub('\'', '\'\\\'\'') .. '\'')

	while true do
		local ln = fd()
		if ln == nil then break end
		local name,ipv4,mac,dev = ln:match("^(%S+) (%S+) (%S+) (%S+)")
		if mac then
			rv[#rv+1] = {
				hostname = name,
				device  = dev,
				macaddr  = mac,
				ipaddr   = ipv4
			}
		end
	end
	return rv
end


if luci.http.formvalue("status") == "1" then
	local rv = {
		onlines   = online_data()
	}	
	luci.http.prepare_content("application/json")
	luci.http.write_json(rv)
	return
end	
-%>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<%+header%>

<style type="text/css">
body {
	background-color: #f4f6f9;
	font-family: 'Google Sans', sans-serif;
	font-size: 16px;
	line-height: 1.6;
	overflow-wrap: break-word;
	word-break: break-all;
}

h2[name="content"] {
	font-size: 28px;
	margin-bottom: 20px;
	border-bottom: 0px solid #ddd;
	padding-bottom: 10px;
	font-weight: 800;
}

.cbi-section {
	background-color: #ffffff;
	border: 1px solid #e0e0e0;
	border-radius: 8px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
	margin-bottom: 30px;
	padding: 25px;
}

.cbi-section > legend {
	font-size: 20px;
	font-weight: 800;
	padding: 0 10px;
	margin-left: 10px;
}

table.cbi-section-table {
	border-collapse: collapse;
	border: none;
	width: 100%;
}

table.cbi-section-table th {
	background-color: #f8f9fa;
	border: none;
	border-bottom: 2px solid #dee2e6;
	padding: 14px 18px;
	text-align: left;
	font-weight: 800;
	white-space: nowrap;
}

table.cbi-section-table td {
	border: none;
	border-top: 1px solid #dee2e6;
	padding: 14px 18px;
	text-align: left;
	vertical-align: middle;
}

table.cbi-section-table tbody tr:hover {
	background-color: #f1f3f5;
}

th.sortable {
	cursor: pointer;
	position: relative;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}

th.sortable:hover {
	background-color: #e9ecef;
}

.sort-arrow {
	font-size: 12px;
	position: absolute;
	right: 18px;
	top: 50%;
	transform: translateY(-50%);
	color: #6c757d;
	display: inline-block;
	width: 1em;
}

.mobile-sorter {
	display: none;
}

[data-darkmode="true"] body {
	background-color: #121212;
	color: #e0e0e0;
}
[data-darkmode="true"] h2[name="content"] {
	border-bottom-color: #444;
}
[data-darkmode="true"] .cbi-section {
	background-color: #1e1e1e;
	border-color: #333;
}
[data-darkmode="true"] .cbi-section > legend {
	color: #eee;
}
[data-darkmode="true"] table.cbi-section-table th {
	background-color: #2a2a2a;
	border-bottom-color: #555;
	color: #f5f5f5;
}
[data-darkmode="true"] table.cbi-section-table td {
	border-top-color: #3a3a3a;
}
[data-darkmode="true"] table.cbi-section-table tbody tr:hover {
	background-color: #2c2c2c;
}
[data-darkmode="true"] th.sortable:hover {
	background-color: #333;
}
[data-darkmode="true"] .sort-arrow {
	color: #aaa;
}


@media (min-width: 769px) and (max-width: 1280px) {
	body {
		font-size: 15px;
	}
	
	h2[name="content"] {
		font-size: 24px;
	}
	
	.cbi-section {
		padding: 20px;
	}

	table.cbi-section-table th,
	table.cbi-section-table td {
		padding: 10px 12px;
	}

	.sort-arrow {
		right: 12px;
	}
}


@media (max-width: 768px) {
  #online_status_table .cbi-section-table-titles {
    display: none;
  }

  .mobile-sorter {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
    padding: 10px;
    background-color: rgb(136 152 170 / 15%);
    border-radius: 4px;
    align-items: center;
  }

  .mobile-sorter strong {
	font-weight: 800;
	margin-right: 8px;
  }

  .mobile-sorter .sort-control {
    padding: 6px 10px;
    background-color: #e9ecef00;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }

  .mobile-sorter .sort-control.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
  }

  #online_status_table tr {
    display: block;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
  }
  
  #online_status_table tr:hover {
	background-color: transparent;
  }

  #online_status_table td {
    display: block;
    text-align: right;
    position: relative;
    padding-left: 50%;
    border: none;
	border-bottom: 1px dotted #ccc;
    min-height: 22px;
  }
  
  #online_status_table td:last-child {
    border-bottom: none;
  }

  #online_status_table td:before {
    content: attr(data-label);
    position: absolute;
    left: 10px;
    font-weight: 800;
    text-align: left;
    padding-right: 10px;
	width: 45%;
	white-space: nowrap;
  }
  
  [data-darkmode="true"] .mobile-sorter {
    background-color: #2a2a2a;
  }
  [data-darkmode="true"] .mobile-sorter strong {
    color: #f1f1f1;
  }
  [data-darkmode="true"] .mobile-sorter .sort-control {
    background-color: #3c3c3c;
    color: #f1f1f1;
    border-color: #555;
  }
  [data-darkmode="true"] .mobile-sorter .sort-control.active {
    background-color: #3399ff;
    border-color: #3399ff;
    color: #ffffff;
  }
  [data-darkmode="true"] #online_status_table tr {
	border-color: #3a3a3a;
  }
  [data-darkmode="true"] #online_status_table td {
	border-bottom-color: #3a3a3a;
  }
}
</style>

<script type="text/javascript" src="<%=resource%>/cbi.js?v=git-19.271.33176-b_E9_80_9A_E7_94_A8_E5_BA_93"></script>
<script type="text/javascript">//<![CDATA[
	var sortColumn = 'hostname';
	var sortDirection = 'asc';
	var latestInfo = {};

	function ipToNum(ip) {
		if (!ip || typeof(ip) !== 'string' || ip === '-') return 0;
		return ip.split('.').reduce(function(num, octet) {
			return (num << 8) + parseInt(octet, 10);
		}, 0);
	}

	function setSort(column) {
		if (sortColumn === column) {
			sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
		} else {
			sortColumn = column;
			sortDirection = 'asc';
		}
		renderTable(latestInfo);
	}

	function renderTable(info) {
		var ls = document.getElementById('online_status_table');
		if (!ls || !info || !info.onlines) return;
		
		latestInfo = info;

		info.onlines.sort(function(a, b) {
			var valA, valB;

			if (sortColumn === 'ipaddr') {
				valA = ipToNum(a.ipaddr);
				valB = ipToNum(b.ipaddr);
			} else {
				valA = a[sortColumn] ? a[sortColumn].toString().toLowerCase() : '';
				valB = b[sortColumn] ? b[sortColumn].toString().toLowerCase() : '';
			}

			var comparison = 0;
			if (valA > valB) {
				comparison = 1;
			} else if (valA < valB) {
				comparison = -1;
			}
			
			return (sortDirection === 'asc') ? comparison : (comparison * -1);
		});

		var allArrows = document.querySelectorAll('.sort-arrow');
		allArrows.forEach(function(span) { span.innerHTML = ''; });
		var activeArrow = document.getElementById('sort-arrow-' + sortColumn);
		if (activeArrow) {
			activeArrow.innerHTML = (sortDirection === 'asc') ? '&#9650;' : '&#9660;';
		}
		
		var allMobileControls = document.querySelectorAll('.sort-control');
		allMobileControls.forEach(function(span) {
			span.classList.remove('active');
			span.innerHTML = span.getAttribute('data-label-short');
		});
		var activeMobileControl = document.querySelector('.sort-control[data-sort="' + sortColumn + '"]');
		if (activeMobileControl) {
			activeMobileControl.classList.add('active');
			activeMobileControl.innerHTML = activeMobileControl.getAttribute('data-label-short') + ((sortDirection === 'asc') ? ' &#9650;' : ' &#9660;');
		}


		while (ls.rows.length > 1) {
			ls.deleteRow(1);
		}

		if (info.onlines.length > 0) {
			info.onlines.forEach(function(device, i) {
				var tr = ls.insertRow(-1);
				tr.className = 'cbi-section-table-row cbi-rowstyle-' + ((i % 2) + 1);

				var cell1 = tr.insertCell(-1);
				cell1.setAttribute('data-label', '<%:Hostname%>');
				cell1.innerHTML = device.hostname ? device.hostname : '?';

				var cell2 = tr.insertCell(-1);
				cell2.setAttribute('data-label', '<%:IPv4-Address%>');
				cell2.innerHTML = device.ipaddr;

				var cell3 = tr.insertCell(-1);
				cell3.setAttribute('data-label', '<%:MAC-Address%>');
				cell3.innerHTML = device.macaddr;

				var cell4 = tr.insertCell(-1);
				cell4.setAttribute('data-label', '<%:Interface%>');
				cell4.innerHTML = device.device;
			});
		} else {
			var tr = ls.insertRow(-1);
			tr.className = 'cbi-section-table-row';
			var td = tr.insertCell(-1);
			td.colSpan = 4;
			td.innerHTML = '<em><br /><%:There is no one online now.%></em>';
		}
	}

	XHR.poll(5, '<%=REQUEST_URI%>', { status: 1 },
		function(x, info) {
			renderTable(info);
		}
	);
	
	document.addEventListener('DOMContentLoaded', function() {
		document.querySelectorAll('th.sortable').forEach(function(th) {
			th.addEventListener('click', function() {
				setSort(th.getAttribute('data-sort'));
			});
		});
		
		document.querySelectorAll('.sort-control').forEach(function(span) {
			span.addEventListener('click', function() {
				setSort(span.getAttribute('data-sort'));
			});
		});
	});
//]]></script>

<h2 name="content"><%:Status%></h2>

<fieldset class="cbi-section">
	<legend><%:user online%></legend>
	
	<div class="mobile-sorter">
		<strong><%:Sort by:%></strong>
		<span class="sort-control" data-sort="hostname" data-label-short="<%:Hostname%>"><%:Hostname%></span>
		<span class="sort-control" data-sort="ipaddr" data-label-short="<%:IP%>"><%:IP%></span>
		<span class="sort-control" data-sort="macaddr" data-label-short="<%:MAC%>"><%:MAC%></span>
		<span class="sort-control" data-sort="device" data-label-short="<%:Interface%>"><%:Interface%></span>
	</div>

	<table class="cbi-section-table" id="online_status_table">
		<tr class="cbi-section-table-titles">
			<th class="cbi-section-table-cell sortable" data-sort="hostname"><%:Hostname%><span class="sort-arrow" id="sort-arrow-hostname"></span></th>
			<th class="cbi-section-table-cell sortable" data-sort="ipaddr"><%:IPv4-Address%><span class="sort-arrow" id="sort-arrow-ipaddr"></span></th>
			<th class="cbi-section-table-cell sortable" data-sort="macaddr"><%:MAC-Address%><span class="sort-arrow" id="sort-arrow-macaddr"></span></th>
			<th class="cbi-section-table-cell sortable" data-sort="device"><%:Interface%><span class="sort-arrow" id="sort-arrow-device"></span></th>
		</tr>
		<tr class="cbi-section-table-row">
			<td colspan="4"><em><br /><%:Collecting data...%></em></td>
		</tr>
	</table>
</fieldset>

<%+footer%>
